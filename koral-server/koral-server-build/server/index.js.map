{"version":3,"names":["Server","loadConfig","loadMaxConfig","path","express","compile","OscServer","Max","config","require","console","log","process","env","ENV","err","app","name","pid","server","useDefaultApplicationTemplate","koralServerBuild","koralServerPublic","setCustomApplicationTemplateOptions","templateEngine","templatePath","join","clientConfigFunction","role","_httpRequest","author","type","useHttps","serverAddress","port","websockets","subpath","useMinifiedFile","router","use","static","stateManager","registerSchema","id","default","nullable","instrument","infos","freeze","lock","settings","data","start","instrumentCollection","getCollection","cache","Map","cacheUpdate","state","values","getValues","key","JSON","stringify","set","onAttach","cachedValues","get","onUpdate","onDetach","oscServer","on","msg","address","value","find","undefined","startsWith","parameter","slice","Object","keys","includes"],"sources":["../../src/server/index.js"],"sourcesContent":["import '@soundworks/helpers/polyfills.js';\nimport { Server } from '@soundworks/core/server.js';\nimport { loadConfig } from '@soundworks/helpers/node.js';\nimport loadMaxConfig from './load-max-config.js';\n\nimport path from 'node:path';\nimport express from 'express';\nimport compile from 'template-literal';\nimport { Server as OscServer } from 'node-osc';\n\nimport '../utils/catch-unhandled-errors.js';\n\n// - General documentation: https://soundworks.dev/\n// - API documentation:     https://soundworks.dev/api\n// - Issue Tracker:         https://github.com/collective-soundworks/soundworks/issues\n// - Wizard & Tools:        `npx soundworks`\n\n(async function() {\n  let Max = null;\n  let config = null;\n\n  try {\n    Max = require('max-api');\n    console.log('max-api found, run in node.script context');\n    config = loadMaxConfig(process.env.ENV, 'koral-server-config');\n  } catch(err) {\n    // console.log(err);\n    console.log('max-api not found, run in pure node.js context');\n    config = loadConfig(process.env.ENV);\n  }\n\n  console.log(`\n  --------------------------------------------------------\n  - launching \"${config.app.name}\" in \"${process.env.ENV || 'default'}\" environment\n  - [pid: ${process.pid}]\n  --------------------------------------------------------\n  `);\n\n  const server = new Server(config);\n\n  server.useDefaultApplicationTemplate();\n\n  if (Max !== null) {\n    try {\n      // configure the server for usage within node.script directory structure\n      const koralServerBuild = 'koral-server-build';\n      const koralServerPublic = 'koral-server-public';\n\n      server.setCustomApplicationTemplateOptions({\n        templateEngine: { compile },\n        templatePath: path.join(koralServerBuild, 'server', 'tmpl'),\n        clientConfigFunction: (role, config, _httpRequest) => {\n          return {\n            role: role,\n            app: {\n              name: config.app.name,\n              author: config.app.author,\n            },\n            env: {\n              type: config.env.type,\n              // use to configure the socket if the server is running on a different\n              // location than the one the client was served from (cf. #90)\n              useHttps: config.env.useHttps,\n              serverAddress: config.env.serverAddress,\n              port: config.env.port,\n              // other config, to review\n              websockets: config.env.websockets,\n              subpath: config.env.subpath,\n              useMinifiedFile: false,\n            },\n          };\n        },\n      });\n\n      server.router.use(express.static(koralServerPublic));\n      server.router.use('/build', express.static(path.join(koralServerBuild, 'public')));\n    } catch (err) {\n      console.log(err);\n    }\n  }\n\n  try {\n    server.stateManager.registerSchema('instrument', {\n      id: {\n        type: 'string',\n        default: null,\n        nullable: true,\n      },\n      instrument: {\n        type: 'string',\n        default: null,\n        nullable: true,\n      },\n      infos: {\n        type: 'string',\n        default: '',\n      },\n      freeze: {\n        type: 'boolean',\n        default: false,\n      },\n      lock: {\n        type: 'boolean',\n        default: false,\n      },\n      settings: {\n        type: 'boolean',\n        default: false,\n      },\n      data: {\n        type: 'any',\n        default: null, \n        nullable: true,\n      },\n    });\n\n    await server.start();\n\n    const instrumentCollection = await server.stateManager.getCollection('instrument');\n    const cache = new Map();\n    const cacheUpdate = (state) => {\n      const values = state.getValues();\n      const {id, instrument} = values;\n      const key = JSON.stringify({id, instrument});\n      cache.set(key, values);\n    };\n\n    instrumentCollection.onAttach((state) => {\n      const values =  state.getValues();\n      const {id, instrument} = values;\n      const cachedValues = cache.get(JSON.stringify({id, instrument}));\n      if (cachedValues) {\n        state.set(cachedValues);\n      };\n    });\n\n    instrumentCollection.onUpdate((state) => {\n      cacheUpdate(state);\n    });\n\n    instrumentCollection.onDetach((state) => {\n      console.log('detach', state.getValues().id, state.getValues().instrument);\n    });\n\n    const oscServer = new OscServer(7999, '127.0.0.1', () => {\n      console.log('Feedback OSC Server is listening');\n    });\n    \n    oscServer.on('message', function (msg) {\n      let [address, id, value] = msg;\n      id = id + '';\n      let instrument = instrumentCollection.find(state => state.get('id') === id)\n      if (instrument !== undefined) {\n        if (address === '/info') {\n          let infos = value + '';\n          if (infos === 'undefined') {\n            infos = \"\";\n          }\n          instrument.set({ infos });\n        } else if (address.startsWith('/settings/')) {\n          let parameter = address.slice(10);\n          const data = instrument.get('data');\n          if (Object.keys(data['settings']).includes(parameter)) {\n            data['settings'][parameter] = (value === 1);\n          }\n          instrument.set({ data })\n        } else {\n          let parameter = address.slice(1);\n          const data = instrument.get('data');\n          if (Object.keys(data).includes(parameter)) {\n            data[parameter] = value;\n            instrument.set({ data });\n          }\n        }\n      }\n    });\n  } catch (err) {\n    console.log(err);\n  }\n}());\n"],"mappings":"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","ignoreList":[]}
